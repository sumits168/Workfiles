{
  "displayName": "MissionControl-GKE-CoreDNS",
  "dashboardFilters": [
    {
      "filterType": "RESOURCE_LABEL",
      "labelKey": "instance",
      "stringValue": "",
      "templateVariable": "instance",
      "valueType": "STRING"
    },
    {
      "filterType": "RESOURCE_LABEL",
      "labelKey": "cluster",
      "templateVariable": "cluster",
      "valueType": "STRING_ARRAY"
    }
  ],
  "description": "",
  "labels": {
    "cloud-monitoring-dashboard-importer": "",
    "goog-imported-grafana-dashboard": "",
    "goog-imported-grafana-dashboard-from-ui": "",
    "goog-imported-grafana-id": "20527",
    "goog-imported-grafana-revision": "134",
    "goog-imported-via-script": ""
  },
  "mosaicLayout": {
    "columns": 48,
    "tiles": [
      {
        "height": 12,
        "width": 12,
        "widget": {
          "title": "Requests (by instance)",
          "pieChart": {
            "chartType": "PIE",
            "dataSets": [
              {
                "minAlignmentPeriod": "60s",
                "timeSeriesQuery": {
                  "outputFullDuration": false,
                  "prometheusQuery": "sum(rate(coredns_dns_requests_total{cluster=~\"${cluster.value}\"}[5m])) by (instance)"
                }
              }
            ]
          }
        }
      },
      {
        "xPos": 12,
        "height": 12,
        "width": 6,
        "widget": {
          "title": "Upstream Health Check Fails",
          "scorecard": {
            "sparkChartView": {
              "sparkChartType": "SPARK_LINE"
            },
            "thresholds": [],
            "timeSeriesQuery": {
              "outputFullDuration": false,
              "prometheusQuery": "sum(rate(coredns_forward_healthcheck_broken_total{instance=~\"${instance.value}\",cluster=~\"${cluster.value}\"}[5m]))"
            }
          }
        }
      },
      {
        "xPos": 18,
        "height": 12,
        "width": 6,
        "widget": {
          "title": "Upstream Rejected Queries",
          "scorecard": {
            "sparkChartView": {
              "sparkChartType": "SPARK_LINE"
            },
            "thresholds": [],
            "timeSeriesQuery": {
              "outputFullDuration": false,
              "prometheusQuery": "sum(rate(coredns_forward_max_concurrent_rejects_total{instance=~\"${instance.value}\",cluster=~\"${cluster.value}\"}[5m]))"
            }
          }
        }
      },
      {
        "xPos": 24,
        "height": 12,
        "width": 6,
        "widget": {
          "title": "Panics",
          "scorecard": {
            "sparkChartView": {
              "sparkChartType": "SPARK_LINE"
            },
            "thresholds": [],
            "timeSeriesQuery": {
              "outputFullDuration": false,
              "prometheusQuery": "sum(rate(coredns_panics_total{instance=~\"${instance.value}\",cluster=~\"${cluster.value}\"}[5m]))"
            }
          }
        }
      },
      {
        "xPos": 30,
        "height": 12,
        "width": 6,
        "widget": {
          "title": "Failed Reloads",
          "scorecard": {
            "sparkChartView": {
              "sparkChartType": "SPARK_LINE"
            },
            "thresholds": [],
            "timeSeriesQuery": {
              "outputFullDuration": false,
              "prometheusQuery": "sum(rate(coredns_reload_failed_total{instance=~\"${instance.value}\",cluster=~\"${cluster.value}\"}[5m]))"
            }
          }
        }
      },
      {
        "xPos": 36,
        "height": 12,
        "width": 6,
        "widget": {
          "title": "CPU Time",
          "scorecard": {
            "gaugeView": {
              "lowerBound": 0,
              "upperBound": 100
            },
            "thresholds": [],
            "timeSeriesQuery": {
              "outputFullDuration": false,
              "prometheusQuery": "sum(rate(process_cpu_seconds_total{instance=~\"${instance.value}\",cluster=~\"${cluster.value}\"}[5m]))"
            }
          }
        }
      },
      {
        "xPos": 42,
        "height": 12,
        "width": 6,
        "widget": {
          "title": "Memory Usage",
          "scorecard": {
            "sparkChartView": {
              "sparkChartType": "SPARK_LINE"
            },
            "thresholds": [],
            "timeSeriesQuery": {
              "outputFullDuration": false,
              "prometheusQuery": "go_memstats_alloc_bytes{instance=~\"${instance.value}\",cluster=~\"${cluster.value}\"}"
            }
          }
        }
      },
      {
        "yPos": 12,
        "height": 14,
        "width": 24,
        "widget": {
          "title": "Responses (latency, internet zone)",
          "xyChart": {
            "chartOptions": {
              "displayHorizontal": false,
              "mode": "COLOR"
            },
            "dataSets": [
              {
                "legendTemplate": "99%",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "histogram_quantile(0.99, sum(rate(coredns_dns_request_duration_seconds_bucket{instance=~\"${instance.value}\", zone=\".\", cluster=~\"${cluster.value}\"}[5m])) by (le))"
                }
              },
              {
                "legendTemplate": "90%",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "histogram_quantile(0.90, sum(rate(coredns_dns_request_duration_seconds_bucket{instance=~\"${instance.value}\", zone=\".\", cluster=~\"${cluster.value}\"}[5m])) by (le))"
                }
              },
              {
                "legendTemplate": "50%",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "histogram_quantile(0.50, sum(rate(coredns_dns_request_duration_seconds_bucket{instance=~\"${instance.value}\", zone=\".\" ,cluster=~\"${cluster.value}\"}[5m])) by (le))"
                }
              }
            ],
            "thresholds": [],
            "yAxis": {
              "scale": "LINEAR"
            }
          }
        }
      },
      {
        "yPos": 12,
        "xPos": 24,
        "height": 14,
        "width": 24,
        "widget": {
          "title": "Requests (total)",
          "xyChart": {
            "chartOptions": {
              "displayHorizontal": false,
              "mode": "COLOR"
            },
            "dataSets": [
              {
                "legendTemplate": "${labels.server}",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "sum(rate(coredns_dns_requests_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m])) by (server)"
                }
              },
              {
                "legendTemplate": "cache",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "sum(rate(coredns_cache_requests_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m]))"
                }
              }
            ],
            "thresholds": [],
            "yAxis": {
              "scale": "LINEAR"
            }
          }
        }
      },
      {
        "yPos": 26,
        "height": 14,
        "width": 24,
        "widget": {
          "title": "Responses (size, internet zone)",
          "id": "",
          "xyChart": {
            "dataSets": [
              {
                "breakdowns": [],
                "dimensions": [],
                "legendTemplate": "99%",
                "measures": [],
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "outputFullDuration": false,
                  "prometheusQuery": "histogram_quantile(0.99, sum(rate(coredns_dns_response_size_bytes_bucket{instance=~\"${instance.value}\", zone=\".\"}[5m])) by (le))",
                  "unitOverride": ""
                }
              },
              {
                "breakdowns": [],
                "dimensions": [],
                "legendTemplate": "90%",
                "measures": [],
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "outputFullDuration": false,
                  "prometheusQuery": "histogram_quantile(0.90, sum(rate(coredns_dns_response_size_bytes_bucket{instance=~\"${instance.value}\", zone=\".\"}[5m])) by (le))",
                  "unitOverride": ""
                }
              },
              {
                "breakdowns": [],
                "dimensions": [],
                "legendTemplate": "50%",
                "measures": [],
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "outputFullDuration": false,
                  "prometheusQuery": "histogram_quantile(0.50, sum(rate(coredns_dns_response_size_bytes_bucket{instance=~\"${instance.value}\", zone=\".\"}[5m])) by (le))",
                  "unitOverride": ""
                }
              }
            ],
            "thresholds": []
          }
        }
      },
      {
        "yPos": 26,
        "xPos": 24,
        "height": 14,
        "width": 24,
        "widget": {
          "title": "Requests (by zone)",
          "id": "",
          "xyChart": {
            "dataSets": [
              {
                "breakdowns": [],
                "dimensions": [],
                "legendTemplate": "${labels.zone}",
                "measures": [],
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "outputFullDuration": false,
                  "prometheusQuery": "sum(rate(coredns_dns_requests_total{instance=~\"${instance.value}\"}[5m])) by (zone)",
                  "unitOverride": ""
                }
              }
            ],
            "thresholds": []
          }
        }
      },
      {
        "yPos": 40,
        "height": 16,
        "width": 24,
        "widget": {
          "title": "Cache (hitrate)",
          "xyChart": {
            "chartOptions": {
              "displayHorizontal": false,
              "mode": "COLOR"
            },
            "dataSets": [
              {
                "legendTemplate": "hits: success",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "sum(rate(coredns_cache_hits_total{instance=~\"${instance.value}\", type=\"success\", cluster=~\"${cluster.value}\"}[5m])) / sum(rate(coredns_cache_requests_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m]))"
                }
              },
              {
                "legendTemplate": "hits: denial",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "sum(rate(coredns_cache_hits_total{instance=~\"${instance.value}\", type=\"denial\", cluster=~\"${cluster.value}\"}[5m])) / sum(rate(coredns_cache_requests_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m]))"
                }
              },
              {
                "legendTemplate": "misses",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "(sum(rate(coredns_cache_requests_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m])) - sum(rate(coredns_cache_hits_total{instance=~\"${instance.value}\", type=\"success\", cluster=~\"${cluster.value}\"}[5m]))) / sum(rate(coredns_cache_requests_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m]))"
                }
              },
              {
                "legendTemplate": "hits: DNSSEC",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "sum(rate(coredns_dnssec_cache_hits_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m])) / sum(rate(coredns_cache_requests_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m]))"
                }
              },
              {
                "legendTemplate": "misses: DNSSEC",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "(sum(rate(coredns_cache_requests_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m])) - sum(rate(coredns_dnssec_cache_hits_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m]))) / sum(rate(coredns_cache_requests_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m]))"
                }
              }
            ],
            "thresholds": [],
            "yAxis": {
              "scale": "LINEAR"
            }
          }
        }
      },
      {
        "yPos": 40,
        "xPos": 24,
        "height": 16,
        "width": 24,
        "widget": {
          "title": "Requests (by type)",
          "xyChart": {
            "chartOptions": {
              "displayHorizontal": false,
              "mode": "COLOR"
            },
            "dataSets": [
              {
                "legendTemplate": "${labels.type}",
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "prometheusQuery": "sum(rate(coredns_dns_requests_total{instance=~\"${instance.value}\", cluster=~\"${cluster.value}\"}[5m])) by (type)"
                }
              }
            ],
            "thresholds": [],
            "yAxis": {
              "scale": "LINEAR"
            }
          }
        }
      },
      {
        "yPos": 56,
        "height": 14,
        "width": 48,
        "widget": {
          "title": "Cache (size)",
          "id": "",
          "scorecard": {
            "breakdowns": [],
            "dimensions": [],
            "measures": [],
            "sparkChartView": {
              "sparkChartType": "SPARK_LINE"
            },
            "thresholds": [],
            "timeSeriesQuery": {
              "outputFullDuration": false,
              "prometheusQuery": "sum(coredns_cache_entries{instance=~\"${instance.value}\"}) by (type)",
              "unitOverride": ""
            }
          }
        }
      }
    ]
  }
}